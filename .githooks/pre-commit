#!/usr/bin/env sh
set -eu

staged_files="$(git diff --cached --name-only --diff-filter=ACMRTUXB)"

# Block committing env files that commonly contain secrets.
blocked_env_files="$(printf '%s\n' "$staged_files" \
  | grep -E '(^|/)\.env($|(\..+)$)|(^|/)[^/]+\.env$' \
  | grep -Ev '(^|/)\.env\.example$|(^|/)\.env\..+\.example$|(^|/)[^/]+\.env\.example$' || true)"

if [ -n "$blocked_env_files" ]; then
  echo "ERROR: Refusing to commit environment files:"
  echo "$blocked_env_files"
  echo "Commit only redacted templates such as .env.example."
  exit 1
fi

# Basic staged-content scan for explicit secret assignments.
if git diff --cached -U0 -- . ':!*.example' ':!*.md' ':!*.txt' ':!*.lock' ':!package-lock.json' \
  | grep -E '^\+.*(API_KEY|OPENAI_API_KEY|SECRET|TOKEN|PASSWORD|PRIVATE_KEY|CLIENT_SECRET)\s*=' >/dev/null 2>&1; then
  echo "ERROR: Possible secret assignment detected in staged changes."
  echo "Move secrets into local untracked env files."
  exit 1
fi

exit 0
